/* ----------------- Start Document ----------------- */
(function($){
	"use strict";
	
	$(document).ready(function(){ 

		//save the number of selected tag in more filters popup
		var selected_tag_number=0;
	
		if($('#listeo_core-search-form').hasClass('ajax-search')){
			$('.fullwidth-filters ').addClass('ajax-search');
		}
		$( '#listeo-listings-container' ).on( 'update_results', function ( event, page, append, loading_previous ) {
			var results      = $('#listeo-listings-container');
			
			var filter 			= $('#listeo_core-search-form');
			var data 			= filter.serializeArray();
			
			//cristian made change
			data = data.filter(function(el) { return el.name != "cristian_date_picker"; }); 
			var style 			= results.data( 'style' );
			var grid_columns 	= results.data( 'grid_columns' );
			var tax_region	 	= results.data( 'region' );
			var tax_category	= results.data( 'category' );
			var tax_feature	 	= results.data( 'feature' );
			var per_page 		= results.data( 'per_page' );
			var custom_class 	= results.data( 'custom_class' );
			var order 	= results.data( 'orderby' );
	
	
			data.push({name: 'action', value: 'listeo_get_listings'});
			data.push({name: 'page', value: page});
			data.push({name: 'style', value: style});
			data.push({name: 'grid_columns', value: grid_columns});
			data.push({name: 'per_page', value: per_page});
			data.push({name: 'custom_class', value: custom_class});
			data.push({name: 'order', value: order});
	
			var has_listing_category_search = false;
			var has_listing_feature_search = false;
			var has_region_search = false;
			$.each(data, function(i, v) {
				if (v.name.substring(0, 15) == 'tax-listing_cat' ) {
					if(v.value){ has_listing_category_search = true; }
				}
	
				if ( v.name.substring(0, 15) == 'tax-listing_fea' ) {
					if(v.value){ has_listing_feature_search = true; }
				}
				if (v.name.substring(0, 9) == 'tax-regio' ) {
					if(v.value){ has_region_search = true; }
				}
			});
			if(!has_region_search) {	if(tax_region) { data.push({name: 'tax-region', value: tax_region}); } };
			if(!has_listing_category_search) { if(tax_category) { data.push({name: 'tax-listing_category', value: tax_category}); } };
			if(!has_listing_feature_search) { if(tax_feature) { data.push({name: 'tax-listing_feature', value: tax_feature}); } };
			console.log(data);
			$.ajax({
				 type 		: "post",
				dataType 	: "json",
				url 		: listeo_core.ajax_url,
				data 		: data,
				beforeSend:function(xhr){
					results.addClass('loading');
				},
				success:function(data){
					
					results.removeClass('loading');
					$( results ).html( data.html );	
					$( 'div.pagination-container' ).html( data.pagination );
					$('.numerical-rating').numericalRating();	
					$('.star-rating').starRating();	
					$( '#listeo-listings-container' ).triggerHandler('update_results_success');
					if(listeo_core.map_provider == 'google'){
						var map =  document.getElementById('map');
						if (typeof(map) != 'undefined' && map != null) {
							mainMap();
						}
					}
					$('.listeo_cat_page_silder').slick({
					  dots: true,
					  infinite: true,
					  speed: 300,
					  slidesToShow: 1,
					  arrows: true,
					  adaptiveHeight: true
					});
					equalheight('.listeo_grid_view_item');
					
				}
			});
		});
		$(document).on( 'change', '.sort-by-select .orderby,#listeo_core-search-form:not(.main-search-form) #keyword_search, #listeo_core-search-form.ajax-search select, .ajax-search input:not(#location_search, #_price_range,.bootstrap-range-slider)', function(e) { 
			var selected_tag=$(this).val();
			var selected_tag_upper=selected_tag.replace("-", " ");

			if ($('.modal_info').find('#cristian_filter_tag_'+selected_tag).length) {
				// found!
				console.log('#cristian_filter_tag_'+selected_tag);
				$("#cristian_filter_tag_"+selected_tag).remove();
				selected_tag_number--;
			}else{
            if($(this).attr('id')!="keyword_search"){//input search text not showing in tag
					$(".modal_info").append("<p class='modal_info_tag' id='cristian_filter_tag_"+selected_tag+"'>"+selected_tag_upper+"<span class='close_modal_info_tag' ></span></p>");
					selected_tag_number++;
				}
			}
			if(selected_tag_number!=0){
				$('.cristian_more_filter').html("Filters ~ "+selected_tag_number+" selected");
				$('.cristian_more_filter').css("background","#ddffdd");
			}

			var target   = $('div#listeo-listings-container' );
			target.triggerHandler( 'update_results', [ 1, false ] );
		} ).on( 'keyup', function(e) {
			
			if ( e.which === 13 ) {
				e.preventDefault();
				$( this ).trigger( 'change' );
				return false;
			}
		});
		$('.bootstrap-range-slider').on('slideStop', function () {
			var target   = $('div#listeo-listings-container' );
			target.triggerHandler( 'update_results', [ 1, false ] );
		});
		// $( '#listeo_core-search-form.ajax-search input.location_search' ).change( function() {
		// 	var target   = $('div#listeo-listings-container' );
		// 	target.triggerHandler( 'update_results', [ 1, false ] );
		// 	//job_manager_store_state( target, 1 );
		// } );
	

		if($('#listeo_core-search-form:not(.main-search-form)').length) {
			
			document.getElementById("listeo_core-search-form").onkeypress = function(e) {
			  var key = e.charCode || e.keyCode || 0;     
			  if (key == 13) {
				  if ($('#location_search:focus').length){ return false; }
				  console.log("cristiantest111");
				var target   = $('div#listeo-listings-container' );
				target.triggerHandler( 'update_results', [ 1, false ] );
				e.preventDefault();
			  }
			}
		}
		
		//click tag close in more filters
		$(document).on('click', 'span.close_modal_info_tag', function(e) {
            $('#tax-listing_category-panel').addClass("active");
            $('#tax-listing_feature-panel').addClass("active");
            $('#_price-panel').addClass("active");
			var temp_tag=$(this).parent().attr('id').slice(20);//delete front string "cristian_filter_tag_"
			console.log(temp_tag);
			$('#' + temp_tag).click();
			
		});
		
		$(document).on('click', 'span.panel-disable,.slider-disable', function(e) {
			var results      = $('#listeo-listings-container');
			results.triggerHandler( 'update_results', [ 1, false ] );
		});
	
		
		//$(document).on('click', 'div.pagination-container a', function(e) {
		$( 'div.pagination-container.ajax-search').on( 'click', 'a', function(e) {
			e.preventDefault();
			var results      = $('#listeo-listings-container');
			var filter = $('#listeo_core-search-form');
			var page   = $(this).parent().data('paged');
			console.log(page);
			if(page=='next'){
				var page = $('.pagination li.current').data('paged') + 1
			}
			if(page=='prev'){
				var page = $('.pagination li.current').data('paged') - 1
			}
			results.triggerHandler( 'update_results', [ page, false ] );
	
			$( 'body, html' ).animate({
				scrollTop: $('.fs-inner-container .search,#titlebar, .ajax-search').offset().top
			}, 600 );
	
			return false;
		} );
	
		var init_layout = $( '#listeo-listings-container' ).data('style');
	
		if(init_layout == 'list') {
			$('.layout-switcher a').removeClass('active');
			$('.layout-switcher a.list').addClass('active');
		} else {
			$('.layout-switcher a:not(.list)').addClass('active');
		}
	
	
		$('.tax-listing_category #tax-listing_category').on('change',function(e) {
				var label = $(this).find(":selected").html();
				$('.page-title').html(label);
		});
	
	
		$('.layout-switcher').on('click', 'a', function(e) {
			e.preventDefault();
			$('.layout-switcher a').removeClass('active');
			$(this).addClass('active');
			var layout = $(this).data('layout');
			var results = $('#listeo-listings-container');
			results.data('style',layout);
			var page   = 1;
			results.triggerHandler( 'update_results', [ page, false ] );
		});
	
		
	// ------------------ End Document ------------------ //
	});
	
	})(this.jQuery);
	
	/*equal hight layout content string*/
	equalheight = function(container){
	var currentTallest = 0,
		 currentRowStart = 0,
		 rowDivs = new Array(),
		 $el,
		 topPosition = 0;
	 jQuery(container).each(function() {
	
	   $el = jQuery(this);
	   jQuery($el).height('auto')
	   topPostion = $el.position().top;
	
	   if (currentRowStart != topPostion) {
		 for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
		   rowDivs[currentDiv].height(currentTallest);
		 }
		 rowDivs.length = 0; // empty the array
		 currentRowStart = topPostion;
		 currentTallest = $el.height();
		 rowDivs.push($el);
	   } else {
		 rowDivs.push($el);
		 currentTallest = (currentTallest < $el.height()) ? ($el.height()) : (currentTallest);
	  }
	   for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
		 rowDivs[currentDiv].height(currentTallest);
	   }
	 });
	}
	
	jQuery(window).load(function() {
	  equalheight('.listeo_grid_view_item');
	});
	
	jQuery(window).resize(function(){
	  equalheight('.listeo_grid_view_item');
	});